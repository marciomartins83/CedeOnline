{% extends 'base.html.twig' %}

{% block title %}Logs de Auditoria{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Logs de Auditoria</h3>
                    <p class="text-muted mb-0">Total de {{ totalLogs }} registros</p>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Entidade</th>
                                    <th>Módulo</th>
                                    <th>IP</th>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                    <tr>
                                        <td>{{ log.dataHora|date('d/m/Y H:i:s') }}</td>
                                        <td>
                                            {% if log.usuario %}
                                                <strong>{{ log.usuario.nome }}</strong><br>
                                                <small class="text-muted">{{ log.usuario.email }}</small>
                                            {% else %}
                                                <span class="text-muted">Sistema</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set badgeClass = {
                                                'CREATE': 'bg-success',
                                                'UPDATE': 'bg-warning',
                                                'DELETE': 'bg-danger',
                                                'LOGIN': 'bg-info',
                                                'LOGOUT': 'bg-secondary',
                                                'PERMISSION_CHANGE': 'bg-primary'
                                            } %}
                                            <span class="badge {{ badgeClass[log.acao] ?? 'bg-secondary' }}">
                                                {{ log.acao }}
                                            </span>
                                        </td>
                                        <td>
                                            <strong>{{ log.entidade }}</strong>
                                            {% if log.entidadeId %}
                                                <br><small class="text-muted">ID: {{ log.entidadeId }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if log.modulo %}
                                                <span class="badge bg-light text-dark">{{ log.modulo }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ log.ip ?: '-' }}</small>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#logModal{{ log.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>

                                    <!-- Modal para detalhes -->
                                    <div class="modal fade" id="logModal{{ log.id }}" tabindex="-1">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Detalhes do Log</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <h6>Informações Básicas</h6>
                                                            <table class="table table-sm">
                                                                <tr><th>Data/Hora:</th><td>{{ log.dataHora|date('d/m/Y H:i:s') }}</td></tr>
                                                                <tr><th>Usuário:</th><td>{{ log.usuario ? log.usuario.nome : 'Sistema' }}</td></tr>
                                                                <tr><th>Ação:</th><td>{{ log.acao }}</td></tr>
                                                                <tr><th>Entidade:</th><td>{{ log.entidade }}</td></tr>
                                                                <tr><th>ID Entidade:</th><td>{{ log.entidadeId ?: '-' }}</td></tr>
                                                                <tr><th>Módulo:</th><td>{{ log.modulo ?: '-' }}</td></tr>
                                                                <tr><th>IP:</th><td>{{ log.ip ?: '-' }}</td></tr>
                                                            </table>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6>Dados</h6>
                                                            {% if log.dadosAnteriores %}
                                                                <h6 class="text-warning">Dados Anteriores:</h6>
                                                                <pre class="bg-light p-2 rounded"><code>{{ log.dadosAnteriores|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_UNICODE')) }}</code></pre>
                                                            {% endif %}
                                                            {% if log.dadosNovos %}
                                                                <h6 class="text-success">Dados Novos:</h6>
                                                                <pre class="bg-light p-2 rounded"><code>{{ log.dadosNovos|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_UNICODE')) }}</code></pre>
                                                            {% endif %}
                                                            {% if not log.dadosAnteriores and not log.dadosNovos %}
                                                                <p class="text-muted">Nenhum dado registrado</p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center">Nenhum log encontrado</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if totalPages > 1 %}
                        <nav aria-label="Navegação de páginas">
                            <ul class="pagination justify-content-center">
                                {% for i in 1..totalPages %}
                                    <li class="page-item {{ i == currentPage ? 'active' : '' }}">
                                        <a class="page-link" href="{{ path('admin_audit_index', {'page': i}) }}">{{ i }}</a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 